import os
from typing import Dict, Any

from fastapi import FastAPI, Request, HTTPException
from telegram import Update
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
WEBHOOK_SECRET = os.getenv("WEBHOOK_SECRET", "")

if not BOT_TOKEN:
    # –ù–µ –ø–∞–¥–∞–µ–º –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ, –Ω–æ –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
    print("WARNING: TELEGRAM_BOT_TOKEN is not set")

app = FastAPI()

tg_app: Application | None = None

# –ü—Ä–æ—Å—Ç–∞—è –ø–∞–º—è—Ç—å –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (–Ω–∞ MVP –æ–∫)
user_state: Dict[int, Dict[str, Any]] = {}


async def start_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message:
        return
    user_state[update.effective_user.id] = {"step": 1, "data": {}}
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –ø–æ–º–æ–≥—É –ø–æ–¥–æ–±—Ä–∞—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å üè°\n\n"
        "–°–∫–∞–∂–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤ –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ/—Ä–∞–π–æ–Ω–µ –∏—â–µ–º? (–Ø–ª—Ç–∞/–°–µ–≤–∞—Å—Ç–æ–ø–æ–ª—å/–ê–ª—É—à—Ç–∞ –∏ —Ç.–¥.)"
    )


async def text_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not update.message or not update.message.text:
        return

    uid = update.effective_user.id
    text = update.message.text.strip()

    st = user_state.get(uid, {"step": 0, "data": {}})
    step = st.get("step", 0)

    if step == 1:
        st["data"]["city"] = text
        st["step"] = 2
        user_state[uid] = st
        await update.message.reply_text("–û–∫! –¶–µ–ª—å: –¥–ª—è –∂–∏–∑–Ω–∏ / –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π / –æ—Ç–¥—ã—Ö–∞?")
        return

    if step == 2:
        st["data"]["goal"] = text
        st["step"] = 3
        user_state[uid] = st
        await update.message.reply_text("–ü–æ–Ω—è–ª–∞. –ë—é–¥–∂–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ –∫–∞–∫–æ–π? (–Ω–∞–ø—Ä–∏–º–µ—Ä: 5 –º–ª–Ω, –¥–æ 12 –º–ª–Ω)")
        return

    if step == 3:
        st["data"]["budget"] = text
        st["step"] = 0
        user_state[uid] = st

        city = st["data"].get("city")
        goal = st["data"].get("goal")
        budget = st["data"].get("budget")

        await update.message.reply_text(
            "–°—É–ø–µ—Ä, –∑–∞–ø–∏—Å–∞–ª–∞ –∑–∞–ø—Ä–æ—Å ‚úÖ\n\n"
            f"–ì–æ—Ä–æ–¥/—Ä–∞–π–æ–Ω: {city}\n"
            f"–¶–µ–ª—å: {goal}\n"
            f"–ë—é–¥–∂–µ—Ç: {budget}\n\n"
            "–ù–∞–ø–∏—à–∏ /start —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å."
        )
        return

    # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –±–µ–∑ /start
    await update.message.reply_text("–ù–∞–ø–∏—à–∏ /start ‚Äî –∏ —è —Å–æ–±–µ—Ä—É –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–¥–±–æ—Ä üôÇ")


@app.on_event("startup")
async def on_startup():
    global tg_app
    tg_app = Application.builder().token(BOT_TOKEN).build()
    tg_app.add_handler(CommandHandler("start", start_cmd))
    tg_app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, text_handler))

    await tg_app.initialize()
    # start() –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ö–∞–Ω–∏–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    await tg_app.start()


@app.on_event("shutdown")
async def on_shutdown():
    global tg_app
    if tg_app:
        await tg_app.stop()
        await tg_app.shutdown()
        tg_app = None


@app.post("/webhook")
async def webhook(request: Request):
    # Telegram –ø—Ä–∏—Å—ã–ª–∞–µ—Ç —Å–µ–∫—Ä–µ—Ç –≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ X-Telegram-Bot-Api-Secret-Token (–µ—Å–ª–∏ —Ç—ã –µ–≥–æ –∑–∞–¥–∞–ª–∞ –ø—Ä–∏ setWebhook)
    secret = request.headers.get("X-Telegram-Bot-Api-Secret-Token", "")
    if WEBHOOK_SECRET and secret != WEBHOOK_SECRET:
        raise HTTPException(status_code=403, detail="Invalid webhook secret")

    data = await request.json()
    update = Update.de_json(data, tg_app.bot)  # type: ignore
    await tg_app.process_update(update)        # type: ignore
    return {"ok": True}